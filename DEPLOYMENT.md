# AWS Deployment Guide

Infrastructure generated by [Sirpi](https://sirpi.dev) for your **express** application.

## üìã Prerequisites

Before deploying, ensure you have:

- ‚úÖ AWS Account with appropriate permissions (VPC, ECS, ALB, IAM, ECR)
- ‚úÖ [AWS CLI](https://aws.amazon.com/cli/) installed and configured
- ‚úÖ [Terraform](https://www.terraform.io/downloads) >= 1.5.0
- ‚úÖ [Docker](https://www.docker.com/get-started) installed
- ‚úÖ [ACM Certificate](https://console.aws.amazon.com/acm) for HTTPS (must be in us-west-2)

## üöÄ Quick Start

### Step 1: Create ACM Certificate

1. Go to AWS Certificate Manager in `us-west-2` region
2. Request a public certificate for your domain
3. Validate the certificate (DNS or Email)
4. Copy the certificate ARN (needed for Terraform)

### Step 2: Configure Terraform Variables

Create `terraform/terraform.tfvars`:

```hcl
app_name               = "myapp"
environment            = "production"
region                 = "us-west-2"
acm_certificate_arn    = "arn:aws:acm:us-west-2:ACCOUNT:certificate/CERT_ID"

# Optional: Customize these
container_cpu          = 256   # 0.25 vCPU
container_memory       = 512   # 512 MB
desired_count          = 2     # Number of tasks
vpc_cidr              = "10.0.0.0/16"
```

### Step 3: Build and Push Docker Image

```bash
# 1. Get your AWS account ID
export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

# 2. Create ECR repository
aws ecr create-repository --repository-name myapp-repo --region us-west-2

# 3. Login to ECR
aws ecr get-login-password --region us-west-2 | \
  docker login --username AWS --password-stdin \
  $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com

# 4. Build Docker image
docker build -t myapp .

# 5. Tag image
docker tag myapp:latest \
  $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/myapp-repo:latest

# 6. Push to ECR
docker push $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/myapp-repo:latest
```

### Step 4: Deploy Infrastructure with Terraform

```bash
# Navigate to terraform directory
cd terraform

# Initialize Terraform
terraform init

# Review what will be created
terraform plan

# Deploy infrastructure (takes 5-10 minutes)
terraform apply

# Get the ALB DNS name
terraform output alb_dns_name
```

### Step 5: Access Your Application

After deployment completes:

1. Get the ALB DNS name: `terraform output alb_dns_name`
2. Create a CNAME record in your DNS pointing to the ALB
3. Wait 2-3 minutes for ECS tasks to start
4. Visit your domain!

## üìä Outputs

After successful deployment, Terraform provides:

```bash
terraform output alb_dns_name           # Access your application here
terraform output ecr_repository_url     # Docker image repository
terraform output ecs_cluster_name       # ECS cluster for monitoring
terraform output cloudwatch_log_group   # Application logs
```

## üîç Monitoring

### View Application Logs

```bash
# Tail logs in real-time
aws logs tail /ecs/myapp --follow --region us-west-2
```

### Check ECS Service Status

```bash
aws ecs describe-services \
  --cluster myapp-cluster \
  --services myapp-service \
  --region us-west-2
```

## üêõ Troubleshooting

### Container fails health check

**Problem**: ECS tasks start but immediately become unhealthy.

**Solution**:
1. Check CloudWatch logs: `aws logs tail /ecs/myapp --follow`
2. Verify your app responds on port 3000
3. Test health check endpoint locally: `curl http://localhost:3000/`

### Terraform apply fails

**Common issues**:
- Missing ACM certificate ARN in `terraform.tfvars`
- Insufficient IAM permissions
- Resource name conflicts (change `app_name` variable)

### Cannot access application

**Checklist**:
1. Wait 2-3 minutes for ECS tasks to reach "RUNNING" state
2. Check security groups allow inbound traffic on ports 80/443
3. Verify ACM certificate is valid and matches your domain
4. Check Route53 CNAME points to ALB DNS name

## üí∞ Cost Estimate

Approximate monthly costs (us-west-2):

| Resource | Cost |
|----------|------|
| ECS Fargate (2 tasks, 0.25 vCPU, 512 MB) | ~$15 |
| Application Load Balancer | ~$20 |
| NAT Gateway | ~$30 |
| Data Transfer | ~$5 |
| ECR Storage | ~$1 |
| CloudWatch Logs | ~$2 |
| **Total** | **~$73/month** |

To reduce costs:
- Use 1 task instead of 2 (`desired_count = 1`)
- Use t3.micro EC2 instead of Fargate
- Enable S3 VPC endpoints to reduce NAT costs

## üßπ Cleanup

To destroy all resources:

```bash
cd terraform
terraform destroy
```

**Warning**: This will delete:
- All ECS tasks and services
- Load balancer and target groups
- VPC, subnets, and networking
- ECR repository and images
- CloudWatch log groups

## üìö Architecture Details

### Network Architecture:
- **VPC**: Isolated network with DNS enabled
- **Public Subnets**: For ALB (0.0.0.0/0 internet access)
- **Private Subnets**: For ECS tasks (internet via NAT)
- **Multi-AZ**: Resources spread across 2 availability zones

### Security:
- ECS tasks run in private subnets (no direct internet access)
- Security groups restrict traffic (ALB ‚Üí ECS on port 3000 only)
- IAM roles follow least-privilege principles
- Container runs as non-root user

### Scaling:
- Auto-scaling configured (min 2, max 10 tasks)
- Circuit breaker enabled (auto-rollback on failures)
- Health checks on both ALB and container level

## üÜò Support

Need help?
- üìñ [Sirpi Documentation](https://docs.sirpi.dev)
- üí¨ [Discord Community](https://discord.gg/sirpi)
- üìß [Email Support](mailto:support@sirpi.dev)

---

<sub>Generated by Sirpi ‚Ä¢ Session: sess_707c38924b1f ‚Ä¢ [View Original Generation](https://sirpi.dev/generation/sess_707c38924b1f)</sub>
